# æœ€çµ‚é †ä½è¡¨ã®è¨˜éŒ²ä¿å­˜å ´æ‰€ - å®Œå…¨ãƒãƒƒãƒ—

## ğŸ“Š æ¦‚è¦
æœ€çµ‚é †ä½è¡¨ã®è¨˜éŒ²ã¯ä»¥ä¸‹ã®è¤‡æ•°ã®å±¤ã«ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€å‰Šé™¤æ™‚ã¯ã™ã¹ã¦ã‚’å¯¾è±¡ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## 1ï¸âƒ£ **ã‚µãƒ¼ãƒãƒ¼å´ï¼ˆMongoDBï¼‰**

### 1-1. `shichuma_results` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
```
{
  _id: ObjectId,
  tournamentId: "KYUDO_20260107_P6ZC",
  shootOffType: "shichuma",
  results: [
    {
      archerId: "archer123",
      name: "ã™ãš",
      affiliation: "ã™ãš",
      rank: 1,
      isWinner: true,
      shootOffType: "shichuma",
      divisionId: "title"
    }
  ],
  completedAt: ISODate
}
```
**å‰Šé™¤æ–¹æ³•**: `DELETE /api/ranking/shichuma/:tournamentId` âœ…

---

### 1-2. `enkin_results` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
```
{
  _id: ObjectId,
  tournamentId: "KYUDO_20260107_P6ZC",
  shootOffType: "enkin",
  results: [
    {
      archerId: "archer123",
      name: "ã™ãš",
      rank: 1,
      targetRank: 2,
      divisionId: "title"
    }
  ],
  completedAt: ISODate
}
```
**å‰Šé™¤æ–¹æ³•**: `DELETE /api/ranking/enkin/:tournamentId` âœ…

---

### 1-3. `applicants` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ - å„é¸æ‰‹å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

#### âœ… å‰Šé™¤å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
```
{
  archerId: "archer123",
  tournamentId: "KYUDO_20260107_P6ZC",
  
  // âŒ ã“ã‚Œã‚‰ãŒå‰Šé™¤ã•ã‚Œã‚‹
  shichumaResults: {
    arrow0: "o",
    arrow1: "x",
    arrow2: "o",
    arrow3: "o"
  },
  enkinRank: 1,
  enkinArrowType: "normal",
  shichumaFinalRank: 1,
  shichumaWinner: true,
  enkinFinalRank: 1,
  
  // âŒ è¨˜éŒ²æœ¬ä½“ï¼ˆå‰Šé™¤ã•ã‚Œã‚‹ï¼‰
  results: {
    stand1: ["o", "x", "o", "o", null, null, null, null, null, null],
    stand2: ["o", "x", "x", "o", null, null, null, null, null, null],
    stand3: [null, null, null, null, null, null, null, null, null, null],
    stand4: [null, null, null, null, null, null, null, null, null, null],
    stand5: [null, null, null, null, null, null, null, null, null, null],
    stand6: [null, null, null, null, null, null, null, null, null, null]
  }
}
```
**å‰Šé™¤æ–¹æ³•**: `POST /api/ranking/clear/:tournamentId` âœ…
  - `results` â†’ `initialResults` ã§å†åˆæœŸåŒ–
  - `shichumaResults` â†’ $unset ã§å‰Šé™¤
  - `enkinRank` â†’ $unset ã§å‰Šé™¤
  - ãã®ä»–å°„è©°ãƒ»é è¿‘ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â†’ $unset ã§å‰Šé™¤

---

## 2ï¸âƒ£ **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼ˆReact Stateï¼‰**

### 2-1. RankingView ã®çŠ¶æ…‹å¤‰æ•°
```jsx
const [shichumaFinalResults, setShichumaFinalResults] = useState(null);
const [enkinFinalResults, setEnkinFinalResults] = useState(null);
```
**å‰Šé™¤æ–¹æ³•**: `deleteFinalResults()` ã§ null ã‚’ã‚»ãƒƒãƒˆ âœ…

---

### 2-2. é–¢é€£ã™ã‚‹çŠ¶æ…‹å¤‰æ•°ï¼ˆåŒæ™‚ã«å‰Šé™¤ï¼‰
```jsx
setShichumaResults({});           // å€‹åˆ¥ã®çŸ¢ã®çµæœ
setEnkinResults({});              // é è¿‘ã®å€‹åˆ¥çµæœ
setEliminatedArchers(new Set());  // è„±è½è€…ãƒªã‚¹ãƒˆ
setEliminationOrder([]);          // è„±è½é †åº
setEliminationRound({});          // è„±è½ãƒ©ã‚¦ãƒ³ãƒ‰
setSimultaneousEliminations([]); // åŒæ™‚è„±è½
setCurrentShootOffArchers([]);    // ç¾åœ¨ã®å¯¾æˆ¦é¸æ‰‹
setOriginalEnkinArchers(new Set()); // å…ƒã®é è¿‘é¸æ‰‹
setSavedEnkinRanks(new Set());    // ä¿å­˜æ¸ˆã¿é è¿‘æ 
setEnkinTargetRank(null);         // é è¿‘å¯¾è±¡é †ä½
setEnkinDefeated(new Set());      // é è¿‘æ•—é€€è€…
setRemainingAfterFourArrows([]); // 4çŸ¢å¾Œã®æ®‹å­˜è€…
setEditingArrow(null);            // ç·¨é›†ä¸­ã®çŸ¢
```

---

## 3ï¸âƒ£ **ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**

### 3-1. localStorage
```javascript
localStorage.getItem('ranking_selectedGender')  // æ€§åˆ¥é¸æŠ
```
**å‰Šé™¤æ–¹æ³•**: `localStorage.removeItem('ranking_selectedGender')` âœ…

---

## 4ï¸âƒ£ **æ´¾ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆè¨ˆç®—çµæœï¼‰**

### 4-1. `categorizedGroups` (useCallback)
- **ã‚½ãƒ¼ã‚¹**: `archers` ã® `results` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰çš„ä¸­æ•°ã‚’è¨ˆç®—
- **è‡ªå‹•ã‚¯ãƒªã‚¢**: `results` ã‚’ã‚¯ãƒªã‚¢ã™ã‚Œã°è‡ªå‹•çš„ã«ç©ºã«ãªã‚‹
- **å‰Šé™¤æ–¹æ³•**: ä¾å­˜åº¦â†“ `results` å‰Šé™¤ã§è‡ªå‹•è§£æ±º âœ…

### 4-2. `getMergedFinalResults()` (useCallback)
- **ã‚½ãƒ¼ã‚¹**: `shichumaFinalResults` ã¨ `enkinFinalResults`
- **è‡ªå‹•ã‚¯ãƒªã‚¢**: ã“ã‚Œã‚‰ã‚’ null ã«è¨­å®šã™ã‚Œã°ç©ºã«ãªã‚‹
- **å‰Šé™¤æ–¹æ³•**: state å‰Šé™¤ã§è‡ªå‹•è§£æ±º âœ…

---

## ğŸ“‹ å‰Šé™¤å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†“
1ï¸âƒ£ DELETE /api/ranking/shichuma/:tournamentId
   â””â†’ shichuma_results ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤
  â†“
2ï¸âƒ£ DELETE /api/ranking/enkin/:tournamentId
   â””â†’ enkin_results ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤
  â†“
3ï¸âƒ£ POST /api/ranking/clear/:tournamentId
   â”œâ†’ applicants: results ã‚’ initialResults ã«å†åˆæœŸåŒ–
   â””â†’ applicants: å°„è©°ãƒ»é è¿‘ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ $unset ã§å‰Šé™¤
  â†“
4ï¸âƒ£ React State ã‚¯ãƒªã‚¢
   â”œâ†’ setShichumaFinalResults(null)
   â”œâ†’ setEnkinFinalResults(null)
   â””â†’ ãã®ä»–15å€‹ã® state ã‚’åˆæœŸåŒ–
  â†“
5ï¸âƒ£ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
   â””â†’ localStorage.removeItem('ranking_selectedGender')
  â†“
6ï¸âƒ£ é…å»¶ï¼ˆ500msï¼‰
  â†“
7ï¸âƒ£ æœ€æ–°ãƒ‡ãƒ¼ã‚¿å†å–å¾—
   â”œâ†’ fetchArchers(true)
   â””â†’ fetchShootOffResults()
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ - å‰Šé™¤å®Œå…¨æ€§ç¢ºèª

| é …ç›® | å‰Šé™¤æ–¹æ³• | çŠ¶æ…‹ |
|------|--------|------|
| `shichuma_results` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | DELETE /api/ranking/shichuma | âœ… |
| `enkin_results` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | DELETE /api/ranking/enkin | âœ… |
| `applicants.results` | POST /api/ranking/clear (init) | âœ… |
| `applicants.shichumaResults` | POST /api/ranking/clear (unset) | âœ… |
| `applicants.enkinRank` | POST /api/ranking/clear (unset) | âœ… |
| `applicants.shichumaFinalRank` | POST /api/ranking/clear (unset) | âœ… |
| `applicants.shichumaWinner` | POST /api/ranking/clear (unset) | âœ… |
| `applicants.enkinFinalRank` | POST /api/ranking/clear (unset) | âœ… |
| `shichumaFinalResults` state | setShichumaFinalResults(null) | âœ… |
| `enkinFinalResults` state | setEnkinFinalResults(null) | âœ… |
| `shichumaResults` state | setShichumaResults({}) | âœ… |
| `enkinResults` state | setEnkinResults({}) | âœ… |
| `eliminatedArchers` state | setEliminatedArchers(new Set()) | âœ… |
| ãã®ä»–13å€‹ã® state | setXxx() | âœ… |
| `ranking_selectedGender` (localStorage) | localStorage.removeItem() | âœ… |

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### MongoDB ã§ç¢ºèª
```javascript
// 1. shichuma_results ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
db.getCollection('shichuma_results').findOne({ tournamentId: 'KYUDO_20260107_P6ZC' })

// 2. enkin_results ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
db.getCollection('enkin_results').findOne({ tournamentId: 'KYUDO_20260107_P6ZC' })

// 3. è©²å½“é¸æ‰‹ã® results ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
db.getCollection('applicants').findOne({ 
  tournamentId: 'KYUDO_20260107_P6ZC',
  archerId: 'archer123'
})
```

### ãƒ–ãƒ©ã‚¦ã‚¶ DevTools ã§ç¢ºèª
```javascript
// localStorage ã‚’ç¢ºèª
console.log(localStorage.getItem('ranking_selectedGender'))

// React DevTools ã§ç¢ºèª
// Profiler â†’ RankingView â†’ shichumaFinalResults, enkinFinalResults ãŒ null ã‹ç¢ºèª
```

---

## ğŸš¨ ã‚ˆãã‚ã‚‹æ®‹å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | åŸå›  | å¯¾ç­– |
|---------|------|------|
| ã€Œ4æœ¬çš„ä¸­ã€ãŒè¡¨ç¤ºã•ã‚ŒãŸã¾ã¾ | `results` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ | POST /api/ranking/clear ãŒå®Ÿè¡Œã•ã‚ŒãŸã‹ç¢ºèª |
| æœ€çµ‚é †ä½è¡¨ãŒå¾©æ´»ã™ã‚‹ | å‰Šé™¤ç›´å¾Œã« fetchShootOffResults() ãŒå¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã€é…å»¶æ™‚é–“ã‚’å¢—ã‚„ã™ |
| éƒ¨é–€åˆ¥ã®æœ€çµ‚é †ä½ãŒæ®‹ã‚‹ | categorizedGroups ãŒ results ã‹ã‚‰è¨ˆç®—ä¸­ | results å‰Šé™¤å¾Œã« forceRefresh ã‚’å®Ÿè¡Œ |
| localStorage é–¢é€£ | å‰Šé™¤å¾Œã« localStorage.getItem() ã‚’èª­ã¿è¾¼ã‚€ | sessionStorage ã«åˆ‡ã‚Šæ›¿ãˆæ¤œè¨ |

